<!DOCTYPE html>
<html>
<head>
    <title>LTI Session Monitor Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-left: 3px solid #333; }
        .success { border-color: green; }
        .error { border-color: red; }
        .info { border-color: blue; }
        button { padding: 10px 20px; margin: 5px; }
    </style>
</head>
<body>
    <h1>LTI Session Monitor Test</h1>

    <div>
        <label>Moodle URL: <input type="text" id="moodleUrl" value="https://moodle.lti.qbnox.com" style="width: 300px;"></label>
        <button onclick="testSession()">Test Session Check</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>

    <h2>Test Results:</h2>
    <div id="logs"></div>

    <script>
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = 'log ' + type;
            div.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            document.getElementById('logs').appendChild(div);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        function testSession() {
            const moodleUrl = document.getElementById('moodleUrl').value;
            const sessionCheckUrl = moodleUrl + '/lib/ajax/service.php';

            log('Testing session check to: ' + sessionCheckUrl, 'info');

            fetch(sessionCheckUrl, {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify([{
                    index: 0,
                    methodname: 'core_session_time_remaining',
                    args: {}
                }])
            })
            .then(response => {
                log('Response status: ' + response.status, 'info');
                if (response.ok) {
                    return response.json();
                } else if (response.status === 401 || response.status === 403) {
                    throw new Error('Session expired (401/403)');
                }
                throw new Error('Network error: ' + response.status);
            })
            .then(data => {
                log('✓ Session check successful!', 'success');
                log('Response: ' + JSON.stringify(data, null, 2), 'success');
            })
            .catch(error => {
                log('✗ Session check failed: ' + error.message, 'error');

                if (error.message.includes('CORS')) {
                    log('CORS error detected. Moodle needs CORS headers configured.', 'error');
                }

                if (error.message.includes('401') || error.message.includes('403')) {
                    log('Session expired - user should be logged out', 'error');
                }
            });
        }

        // Run initial test
        log('Session monitor test page loaded', 'info');
        log('Instructions:', 'info');
        log('1. Make sure you are logged into Moodle', 'info');
        log('2. Click "Test Session Check" to verify connection', 'info');
        log('3. Log out of Moodle in another tab', 'info');
        log('4. Click "Test Session Check" again - should fail', 'info');
    </script>
</body>
</html>
