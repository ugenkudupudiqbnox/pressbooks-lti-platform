version: "3.9"

networks:
  lti-net:

services:
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: root
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-proot"]
      interval: 5s
      timeout: 5s
      retries: 20

  moodle:
    image: bitnami/moodle:5.1
    depends_on:
      mysql:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/login/index.php"]
      interval: 10s
      timeout: 5s
      retries: 20
    environment:
      MOODLE_DATABASE_HOST: mysql
      MOODLE_DATABASE_USER: root
      MOODLE_DATABASE_PASSWORD: root
      MOODLE_DATABASE_NAME: moodle
      MOODLE_SITE_NAME: "Moodle Local"
    ports:
      - "8080:8080"
    networks: [lti-net]

pressbooks:
  image: wordpress:6.4-php8.1-apache
  depends_on:
    mysql:
      condition: service_healthy
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost/wp-login.php"]
    interval: 10s
    timeout: 5s
    retries: 20
  container_name: pressbooks
  environment:
    WORDPRESS_DB_HOST: mysql
    WORDPRESS_DB_USER: root
    WORDPRESS_DB_PASSWORD: root
    WORDPRESS_DB_NAME: pressbooks
    WORDPRESS_DEBUG: 1
  volumes:
    - ./pressbooks:/var/www/html
  ports:
    - "8081:80"
  depends_on:
    - mysql
  networks:
    - lti-net
